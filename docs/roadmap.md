# Call Centre CRM - Roadmap

## Этап 1: Подготовка проекта и базовая структура

### 1.1 Инициализация проекта
- [X] Создать структуру проекта
- [X] Настроить базовую конфигурацию
- [X] Выбрать и настроить технологический стек (Next.js 14 + TypeScript + shadcn/ui + reui, Node.js + Express + Prisma, PostgreSQL + Redis)
- [X] Создать package.json и установить зависимости
  - Frontend: Next.js 14, TypeScript, Tailwind CSS, shadcn/ui, reui, React Query, React Hook Form, Zustand
  - Backend: Node.js, Express.js, TypeScript, Prisma, JWT, bcrypt, multer, Socket.io
  - Database: PostgreSQL, Redis
  - Tools: Winston (logging), node-cron, axios

### 1.2 Настройка базы данных
- [X] Создать PostgreSQL базу данных
- [X] Создать таблицу `callcentre_admin` (id, login, password, note)
- [X] Создать таблицу `callcentre_operator` (id, name, login, password, city, status, status_work, passport, contract, date_create, note)
- [X] Создать таблицу `avito` (id, name, client_id, client_secret)
- [X] Создать таблицу `phones` (id, number, rk, city)
- [X] Создать таблицу `orders` (id, rk, city, avito_name, phone, type_order, client_name, address, date_meeting, type_equipment, problem, call_record, status_order, master_id, result, expenditure, clean, bso_doc, expenditure_doc, operator_name_id, create_date, closing_data)
- [X] Создать таблицу `calls` (id, rk, city, avito_name, phone_client, phone_ats, date_create, operator_name, status)
- [X] Создать таблицу `mango` (для интеграции с телефонией)

### 1.3 Backend API основа
- [X] Создать Express.js сервер
- [X] Настроить подключение к PostgreSQL
- [X] Создать базовую структуру роутов
- [X] Настроить middleware для обработки запросов

## Этап 2: Система аутентификации и авторизации

### 2.1 Аутентификация
- [X] Создать API для логина/logout
- [X] Реализовать JWT токены
- [X] Создать middleware для проверки авторизации
- [X] Разделить права доступа (админ/оператор)

### 2.2 Страница входа
- [X] Создать компонент страницы логина
- [X] Реализовать форму входа (логин/пароль)
- [X] Добавить валидацию формы
- [X] Интегрировать с API аутентификации

## Этап 3: Базовый интерфейс и навигация

### 3.1 Основной макет
- [X] Создать компонент Header с навигационным меню
- [X] Реализовать боковое меню или верхнее меню
- [X] Создать базовый layout компонент
- [X] Добавить роутинг между страницами

### 3.2 Навигационное меню
- [X] Добавить пункт "Телефония"
- [X] Добавить пункт "Центр сообщений"
- [X] Добавить пункт "Заказы"
- [X] Добавить пункт "Статистика"
- [X] Создать выпадающее меню профиля (Профиль, Зарплата)

## Этап 4: Страница Телефония

### 4.1 API для звонков
- [X] Создать API для получения списка звонков
- [X] Реализовать фильтрацию по параметрам
- [X] Добавить пагинацию

### 4.2 Интерфейс телефонии
- [X] Создать таблицу звонков с колонками: РК, Город, Имя Авит, кто звонил, куда звонил, дата звонка, имя оператора, запись звонка
- [X] Добавить кнопку "Создать заявку" для каждого звонка
- [X] Реализовать сортировку и фильтрацию
- [X] Добавить проигрывание записей звонков

### 4.3 Создание заказа из звонка
- [X] Создать модальное окно/страницу создания заказа
- [X] Автозаполнить поля: РК, Город, Имя мастера, Номер телефона, Запись звонка
- [X] Добавить выпадающий список "Тип заявки" (Впервые/Повтор/Гарантия)
- [X] Добавить выпадающий список "Тип техники" (КП/БТ/МНЧ)
- [X] Создать поля для ручного заполнения: Имя клиента, Адрес, Дата встречи, Проблема
- [X] Реализовать сохранение заказа

## Этап 5: Центр сообщений (Авито чаты)

### 5.1 Интеграция с Авито API
- [X] Изучить API Авито для получения сообщений
- [X] Создать модуль для работы с Авито API
- [X] Реализовать получение списка диалогов
- [X] Реализовать получение сообщений из диалогов

### 5.2 Интерфейс центра сообщений
- [X] Создать список диалогов с информацией: имя клиента, название объявления, город, имя аккаунта авито
- [X] Реализовать открытие диалога для переписки
- [X] Добавить возможность отправки сообщений
- [X] Добавить кнопку "Создать заказ" для каждого чата

### 5.3 Создание заказа из чата
- [X] Автозаполнить поля: РК, Город, Имя мастера, Имя клиента
- [X] Использовать ту же форму создания заказа, что и для телефонии

## Этап 6: Страница заказов

### 6.1 API для заказов
- [X] Создать API для получения списка заказов
- [X] Реализовать создание нового заказа
- [X] Добавить редактирование заказов
- [X] Реализовать изменение статуса заказов

### 6.2 Интерфейс заказов
- [X] Создать таблицу со всеми заказами
- [X] Добавить кнопку "Добавить заказ"
- [X] Реализовать фильтрацию и поиск
- [X] Добавить возможность редактирования заказов
- [X] Обновить таблицу для отображения всех колонок: id, rk, city, avito_name, phone, type_order, client_name, address, date_meeting, type_equipment, problem, master_id, result, operator_name_id
- [X] Исправить проблему с отображением заказов - добавить поддержку поиска в API и правильную фильтрацию по ролям
- [X] Исправить ошибку SSR с localStorage - использовать useEffect для получения данных пользователя на клиенте
- [X] Убрать отладочные логи и исправить проблемы с ProtectedRoute
- [X] Исправить получение данных пользователя - использовать useAuthStore вместо прямого обращения к localStorage
- [X] Исправить отображение пустых значений в таблице заказов и улучшить обработку данных
- [X] Исправить обработку ответа API - извлекать data из { success: true, data: {...} } структуры
- [X] Убрать колонки БСО и Расходы из таблицы заказов
- [X] Переименовать колонки: "Авито" → "Имя мастера", "Результат" → "Итог"
- [X] Увеличить ширину колонок таблицы для лучшей читаемости
- [X] Значительно увеличить ширину всех колонок таблицы заказов
- [X] Сделать колонки таблицы ОЧЕНЬ широкими для лучшей читаемости
- [X] Сделать контейнер таблицы и всей страницы шире для лучшего отображения
- [X] Оптимизировать ширину колонок таблицы для размещения всех данных на экране
- [X] Исправить отображение имени мастера - показывать avito_name вместо masterId
- [X] Добавить колонку "Статус" после колонки "Проблема" для отображения status_order
- [X] Переделать верхнюю часть страницы: объединить поиск и фильтры в одну строку, убрать карточку с количеством заявок, добавить мини-таблицу с временными слотами 10:00-22:00 (интервал 30 мин)
- [X] Изменить мини-таблицу временных слотов: добавить 3 строки для типов техники (КП, БТ, МНЧ) вместо одной общей колонки
- [X] Исправить функциональность поиска: добавить поиск по ID, номеру телефона и адресу
- [X] Переделать модальное окно просмотра заказа: улучшить структуру, добавить иконки, цветовое кодирование и лучшую организацию информации
- [X] Увеличить размер модального окна просмотра заказа для лучшего использования пространства экрана
- [X] Сделать модальное окно максимально большим: использовать 95% ширины и высоты экрана
- [X] Заменить Dialog компонент на кастомное модальное окно для полного контроля над размерами
- [X] Оптимизировать размер модального окна: уменьшить до 90% ширины и 85% высоты экрана
- [X] Дополнительно уменьшить размер модального окна: 85% ширины и 80% высоты экрана
- [X] Разделить модальное окно просмотра заказа на 3 вкладки: Описание, Мастер, Документы
- [X] Обновить вкладку "Описание" для отображения полей: rk, city, avito_name, phone, type_order, client_name, address, date_meeting, type_equipment, problem, status_order, operator_name_id
- [X] Перенести поля "Телефон" и "Тип заявки" из левой колонки в правую колонку "Детали заказа"
- [X] Обновить вкладку "Мастер" для отображения полей: master_id, result (число), expenditure (число), clean (число)
- [X] Обновить вкладку "Документы" для отображения полей: bso_doc, expenditure_doc
- [X] Исправить ошибку "Info is not defined" - добавить недостающий импорт иконки Info
- [X] Добавить поле "call_record" в секцию "Оператор" во вкладке "Описание"
- [X] Создать модальное окно редактирования заказа с тремя вкладками (Описание, Мастер, Документы) аналогично модальному окну просмотра
- [X] Ограничить права редактирования для оператора: может редактировать только Город, Телефон, Тип заявки, Адрес, Дата встречи, Тип техники, Описание проблемы
- [X] Исправить баг с отображением времени в поле "Дата встречи" - использовать локальное время вместо UTC
- [X] Обновить модальное окно создания заказа в /messages: убрать строку "Объявление", добавить поле "Номер"
- [X] Исправить ошибку "Phone is not defined" - добавить недостающий импорт иконки Phone в CreateOrderFromChatModal
- [X] Исправить баг с полем РК при создании заказа - должно записываться "РК - Авито" вместо имени аккаунта Авито
- [X] Убрать дублирование поля "Номер" - оставить только в правой колонке "Детали заказа"
- [X] Изменить значение поля РК с "РК - Авито" на просто "Авито"
- [X] Исправить баг с сохранением номера телефона в БД при создании заказа из чата - добавить поле phone в интерфейс и обработку
- [X] Добавить отображение ID чата в модальном окне создания заказа из чата Авито
- [X] Добавить отображение ID чата в заголовке диалога Авито на странице /messages
- [X] Добавить поле avito_chatid в таблицу orders в БД и записывать ID чата при создании заказа из чата Авито
- [X] Добавить кнопку "Привязанные заказы" рядом с кнопкой "Создать заказ" и показывать заказы, относящиеся к этому чату
- [X] Исправить кривой заголовок модального окна "Привязанные заказы" - перенести ID чата в описание
- [X] Исправить дизайн карточки заказа в модальном окне "Привязанные заказы" - сделать более аккуратной и читаемой
- [X] Исправить кнопку "Открыть" в модальном окне "Привязанные заказы" - добавить переход к странице заказов с открытием конкретного заказа
- [X] Исправить ошибку "Cannot access 'ordersData' before initialization" - переместить useEffect после объявления useQuery
- [X] Исправить отображение в карточке заказа - показывать город вместо адреса рядом с номером телефона
- [X] Сделать карточку заказа в модальном окне "Привязанные заказы" более компактной - уменьшить отступы и размеры элементов
- [X] Убрать с страницы /stats секции "Заказы по статусам", "Статистика по городам" и "Статистика по РК"
- [X] Реализовать интеграцию с Mango ATC через webhook - создать endpoint, обработку событий и автоматическое создание записей звонков
- [X] Обновить фронтенд для отображения звонков в реальном времени - добавить автообновление, индикаторы новых звонков
- [X] Добавить настройки Mango ATC в админ панель - создать страницу конфигурации с тестированием подключения
- [X] Создать подробную инструкцию по настройке webhook в панели Mango Office
- [X] Исправить проблему с rate limiting в nginx для webhook endpoints Mango Office

## Этап 7: Статистика сотрудника

### 7.1 API статистики
- [X] Создать API для подсчета принятых звонков
- [X] Реализовать подсчет пропущенных звонков
- [X] Добавить подсчет созданных заказов
- [X] Создать агрегацию данных по периодам

### 7.2 Интерфейс статистики
- [X] Создать дашборд с основными метриками
- [X] Добавить графики и диаграммы
- [X] Реализовать фильтрацию по датам
- [X] Показать детализацию по каждому показателю

## Этап 8: Профиль сотрудника

### 8.1 API профиля
- [X] Создать API для получения данных профиля
- [X] Реализовать редактирование профиля

### 8.2 Интерфейс профиля
- [X] Показать информацию: Имя сотрудника, Роль, города сотрудника, дата начала работы
- [X] Добавить возможность редактирования некоторых полей
- [X] Создать заглушку для страницы "Зарплата"

## Этап 9: Админ панель

### 9.1 Управление сотрудниками
- [X] Создать API для управления сотрудниками
- [X] Реализовать страницу со списком сотрудников
- [X] Добавить возможность добавления новых сотрудников
- [X] Реализовать редактирование и удаление сотрудников

### 9.2 Управление Авито аккаунтами
- [X] Создать API для управления Авито аккаунтами
- [X] Реализовать страницу со списком аккаунтов
- [X] Добавить возможность добавления новых аккаунтов
- [X] Показать данные о каждом аккаунте

### 9.3 Управление телефонией
- [X] Создать API для управления номерами телефонов
- [X] Реализовать страницу со списком номеров
- [X] Показать данные: номер, РК, город
- [X] Добавить возможность добавления новых номеров

### 9.4 Админ статистика
- [X] Создать общую статистику по всем операторам
- [X] Показать количество звонков, пропущенных звонков, созданных заказов
- [X] Добавить сводные отчеты

## Этап 10: Интеграции и дополнительный функционал

### 10.1 Интеграция с телефонией (Mango)
- [X] Изучить API Mango Office
- [X] Реализовать получение данных о звонках
- [X] Настроить webhook'и для получения уведомлений о звонках
- [X] Синхронизировать данные звонков с базой
- [X] Исправить парсинг данных webhook от Mango Office (правильный формат JSON)
- [X] Добавить номер АТС в таблицу phones для корректной работы системы
- [X] Добавить колонку avito_name в таблицу phones
- [X] Обновить админку для указания названия аккаунта Avito
- [X] Улучшить форму создания заказа из звонка на странице /telephony

### 10.2 Обработка записей звонков
- [X] Реализовать загрузку и хранение записей звонков
- [X] Добавить проигрыватель аудио записей
- [X] Оптимизировать хранение медиа файлов
- [X] Создать страницу настроек почты в админке
- [X] Реализовать мониторинг почты для получения записей от Mango
- [X] Добавить cron задачи для автоматической проверки почты
- [X] Создать API для управления записями звонков
- [X] Интегрировать систему записей в интерфейс телефонии
- [X] Исправить проблему дублирования записей между звонками
- [X] Добавить полноценный аудиоплеер с паузой и перемоткой
- [X] Реализовать систему очистки дублированных записей
- [X] Добавить связь между заказами и звонками (many-to-many)
- [X] Обновить схему БД для связи заказов со звонками
- [X] Добавить отображение связанных звонков в таблице заказов
- [X] Реализовать отображение записей звонков в модальном окне заказа
- [X] Добавить полноценный аудиоплеер для записей в модальном окне заказа

## Этап 11: Финализация и полировка

### 11.1 UI/UX улучшения
- [X] Провести ревью дизайна всех страниц
- [X] Добавить loading состояния
- [X] Улучшить обработку ошибок
- [X] Добавить уведомления и алерты
- [X] Исправить ошибки в статистике (дублирующиеся ключи, логика дат)

### 11.2 Безопасность
- [X] Провести аудит безопасности
- [X] Добавить дополнительную валидацию
- [X] Настроить CORS и другие security headers
- [X] Реализовать логирование действий пользователей

### 11.3 Оптимизация
- [X] Оптимизировать запросы к базе данных
- [X] Добавить кэширование
- [X] Оптимизировать производительность фронтенда
- [X] Провести нагрузочное тестирование

## Этап 11.4 Исправления
- [X] Исправить редактирование заявок на странице /orders

## Этап 12: Безопасность продакшена
- [X] Реализовать полную поддержку HTTPS с SSL сертификатами
- [X] Добавить security headers и Content Security Policy
- [X] Настроить автоматический редирект HTTP → HTTPS
- [X] Создать конфигурацию Nginx с SSL best practices
- [X] Добавить health check endpoints для SSL мониторинга
- [X] Создать скрипты для генерации и управления SSL сертификатами
- [X] Настроить Docker конфигурацию для HTTPS развертывания
- [X] Документировать процесс настройки HTTPS для продакшена

## Этап 13: Конфигурация доменов для продакшена
- [X] Настроить проект для работы с продакшен доменами (apikc.lead-schem.ru, callcentre.lead-schem.ru)
- [X] Обновить CORS настройки для новых доменов
- [X] Настроить SSL сертификаты для wildcard домена *.lead-schem.ru
- [X] Создать отдельные Nginx конфигурации для backend и frontend доменов
- [X] Обновить Docker Compose для продакшен доменов
- [X] Настроить переменные окружения для доменной архитектуры
- [X] Создать скрипты генерации SSL для конкретных доменов
- [X] Документировать процесс настройки DNS и развертывания
- [X] Создать полное руководство по продакшен развертыванию

## Этап 14: CI/CD и автоматизация развертывания
- [X] Создать GitHub Actions workflow для автоматической интеграции и развертывания
- [X] Настроить безопасное управление секретами через GitHub Secrets
- [X] Реализовать автоматическое развертывание staging из Pull Requests
- [X] Настроить автоматическое развертывание production из main ветки
- [X] Создать workflow для ручного развертывания с выбором окружения
- [X] Добавить security сканирование (npm audit, Snyk) в CI/CD
- [X] Реализовать автоматические тесты (линтинг, типизация, Docker build)
- [X] Настроить post-deploy тестирование (health checks, performance, security)
- [X] Создать скрипты для массовой настройки GitHub Secrets
- [X] Документировать полный процесс CI/CD и troubleshooting
- [X] Добавить Telegram уведомления о статусе развертывания
- [X] Создать staging environment с отдельной конфигурацией
- [X] Убрать английские варианты из валидации заказов - оставить только русские значения
- [X] Настроить сортировку заказов: сначала по статусу "Ожидает", затем по приоритету статусов (Принял → В пути → В работе → Модерн → Готово → Отказ → Незаказ), затем по дате встречи
- [X] Настроить цвета для статусов заказов: Ожидает(желтый) Принял(светло синий) В пути(синий) В работе(светло желтый) Готово(зеленый) Отказ(красный) Модерн(оранжевый) Незаказ(черный)
- [X] Исправить таблицу "Заявки на сегодня по времени" - использовать русские значения типов техники (КП, БТ, МНЧ) и фильтровать только заявки на сегодняшний день
- [X] Исправить модальное окно редактирования заказа - использовать правильные значения типов техники (КП, БТ, МНЧ)
- [X] Исправить фильтры статусов на фронтенде - использовать русские значения вместо английских

## Этап 12: Документация
- [X] Создать техническую документацию
- [X] Написать руководство пользователя
- [X] Документировать API
- [X] Создать инструкции по развертыванию

## Этап 13: Улучшения UX
- [X] Сделать /telephony основной страницей после логина для операторов
- [X] Добавить редирект с главной страницы / на /telephony для операторов
- [X] Убрать иконку поиска из шапки, оставить только уведомления
- [X] Убрать сложную систему уведомлений - оставить простую иконку колокольчика
- [X] Переделать шапку: логотип и "Рабочее место" слева, навигация по центру, иконки справа
- [X] Добавить статус работы оператора в шапку с выпадающим списком (Онлайн, Оффлайн, Перерыв)
- [X] Добавить API для обновления статуса работы в БД при изменении в интерфейсе
- [X] Исправить синхронизацию статуса - загружать текущий статус из БД при инициализации
- [X] Автоматически устанавливать статус "Оффлайн" при выходе из системы

## Этап 14: Безопасность прокси для Авито
- [X] Добавить проверку прокси перед отправкой запросов к Авито API
- [X] Реализовать тестирование прокси-соединения через httpbin.org
- [X] Добавить детальную диагностику ошибок прокси (ECONNREFUSED, ETIMEDOUT, ENOTFOUND, 407)
- [X] Интегрировать проверку прокси в testConnection и syncAccountData методы
- [X] Обновлять статус прокси в базе данных (working/failed/not_checked)
- [X] Предотвращать отправку запросов к Авито при неработающем прокси
- [X] Добавить настройки прокси в модальное окно редактирования аккаунта
- [X] Добавить кнопку "Проверить прокси" в форму редактирования
- [X] Создать API endpoint для тестирования прокси без Авито API
- [X] Исправить ошибку "Failed to authenticate with Avito API" при тестировании прокси
- [X] Добавить детальную диагностику ошибок прокси (EPROTO, ECONNRESET, SOCKS)
- [X] Улучшить обработку различных типов прокси (HTTP, SOCKS4, SOCKS5)
- [X] Добавить детальное логирование запросов к Авито API через прокси
- [X] Добавить диагностическое тестирование без прокси для сравнения
- [X] Улучшить обработку ошибок аутентификации Авито API (400, invalid_client, invalid_grant)
- [X] Настроить автоматическое использование прокси для всех запросов к Авито API при наличии данных в БД
- [X] Исправить проблемы с методом testConnection при использовании прокси - применить рабочий https-proxy-agent
- [X] Исправить проблемы с синхронизацией данных через прокси - обновить все API методы для использования рабочего https-proxy-agent
- [X] Добавить поле ID Профиля (user_id) в модальные окна создания и редактирования Avito аккаунтов
- [X] Переделать /messages (AvitoMessengerService) для работы через индивидуальные прокси каждого аккаунта
- [X] Добавить опцию "Все аккаунты" на странице /messages для просмотра чатов со всех аккаунтов одновременно
- [X] Исправить скролл и layout на странице /messages - добавить правильные ограничения высоты для списка чатов и диалога сообщений
- [X] Исправить полностраничный скролл на /messages - использовать fixed positioning для контейнера
- [X] Исправить мелкие UI проблемы: убрать подзаголовок, правильное склонение "аккаунта", выровнять кнопку отправки сообщений
- [X] Упростить интерфейс /admin/avito - убрать лишние кнопки (детальная диагностика, тестирование подключения)
- [X] Добавить секцию статистики (общие просмотры/контакты) и инструментов управления (Проверка прокси, Вечный онлайн, АвтоОтвет, БидМенеджер, Статистика ТОП, Отзывы)
- [X] Перенести статистику просмотров/контактов в верхние карточки к общей статистике и переместить инструменты управления под них
- [X] Создать модальное окно "Проверка прокси" со списком всех аккаунтов, их прокси данными и индивидуальными кнопками проверки
- [X] Улучшить отображение данных прокси: показывать логин, маскированный пароль с возможностью просмотра, улучшить обработку ошибок аутентификации
- [X] Исправить загрузку паролей прокси: создать отдельный API endpoint для получения полных данных прокси с паролями
- [X] Создать модальное окно "Вечный онлайн" с отображением статуса онлайн каждого аккаунта и ползунком для включения/выключения автоматического поддержания онлайна
- [X] Реализовать сохранение настроек вечного онлайна в базу данных (новые поля: eternal_online_enabled, is_online, last_online_check, online_keep_alive_interval)
- [X] Создать фоновые процессы для автоматического поддержания онлайна через регулярные вызовы Avito API
- [X] Исправить ошибки маршрутизации - переместить специфичные маршруты перед параметризированными в Express
- [X] Добавить автоматическое обновление токена в процессе вечного онлайна для исправления ошибок 401 Unauthorized
- [X] Реализовать функциональность "Отзывы" - создать backend API для работы с Avito Ratings API и модальное окно с рейтингами и отзывами аккаунтов
- [X] Добавить кнопку "Справочник" в верхнее меню операторов с выпадающим списком (Правила сотрудника, Правило приема заказов, Прайс, Незаказы)
- [X] Исправить редирект неавторизованных пользователей с главной страницы на /login вместо показа "Перенаправление..."
- [X] Изменить логику отображения заказов - операторы теперь видят все заказы (не только свои)
- [X] Добавить столбец "Мастер" (master_id) в таблицу заказов на странице /orders перед столбцом "Итог"
- [X] Разрешить операторам редактирование полей "Статус" и "Имя мастера" в модальном окне редактирования заказов
- [X] Заменить фильтрацию по РК на поиск по мастеру на странице /orders
- [X] Добавить столбец "Дата закрытия" в таблицу заказов после даты встречи и фильтр по дате закрытия
- [X] Исправить логику мастеров - разделить "Авито аккаунт" (avitoName) и "Мастер" (masterId), настроить фильтрацию по именам мастеров
- [X] Исправить названия полей в модальных окнах просмотра и редактирования - правильно разделить avitoName и master.name
- [X] Добавить включение данных master в API методы getOrder и updateOrder для корректной работы selectedOrder.master?.name
- [X] Убрать ограничения на минимальную дату и автозаполнение в формах создания заказа на страницах /telephony, /orders и /messages
- [X] Добавить автоматическое форматирование номера телефона (только цифры) в формах создания заказа на страницах /orders и /messages
- [X] Убрать отладочные логи из консоли на странице /orders и в Header компоненте

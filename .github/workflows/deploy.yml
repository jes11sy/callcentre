name: Deploy (production)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            sudo mkdir -p /opt/callcentre-crm
            sudo chown $USER:$USER /opt/callcentre-crm || true
            cd /opt/callcentre-crm

            if [ ! -d .git ]; then
              git clone https://github.com/${{ github.repository }} . || true
            fi
            git fetch --all -p || true
            git checkout main
            git reset --hard ${{ github.sha }}

            # Write production env (read from GitHub Secrets)
            cat > .env << 'EOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            EOF

            # Bring up stack
            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans

            # Health check with retries (allow containers to warm up)
            tries=0
            until curl -fsS -k -H "Host: apikc.lead-schem.ru" https://127.0.0.1/api/health >/dev/null 2>&1; do
              tries=$((tries+1))
              if [ $tries -ge 24 ]; then
                echo "Health check failed after $tries attempts"
                docker logs --tail=200 callcentre-backend || true
                docker logs --tail=200 callcentre-nginx || true
                exit 1
              fi
              echo "Waiting for services... attempt $tries"
              sleep 5
            done
            echo "Health check passed"